# 동시성2
##### 클라이언트/서버 예제에서는 단일 스레드로 동작하던 서버를 다중 스레드로 변경하는 것과 코드를 깨끗하게 변경하는 내용을 다룬다.

## 클라이언트/서버 예제
일반적으로 애플리케이션에서 많은 시간을 보내는 가능성은 크게 2가지이다.
 - I/O : 소켓 사용, 데이터베이스 연결, 가상 메모리 스와핑 기다리기 등
 - 프로세서 : 수치 계산, 정규 표현식 처리, 가비지 컬렉션 등

일반적으로 프로그램이 프로세서 연산에 많은 시간을 보낸다면, 하드웨어를 추가하여 성능을 높이는 방식이 적합하다.
프로세서 연산에 시간을 보내는 프로그램은 스레드를 늘린다고 해결할 수 있는 문제가 아니다.
하지만 프로그램이 주로 I/O 연산에 시간을 보낸다면 동시성이 성능을 높여 줄 수 있다.

단일스레드 시스템에서 다중 스레드 시스템으로 변환하고, 성능을 높이기 위해서는 다음과 같은 방법을 사용해야한다.
 - 프로그램이 I/O에 많은 시간을 보내야 한다.
 - 관련된 코드(스레드)를 분리시켜 여러개의 클래스로 분리(스레드를 관리하는 코드는 스레드만 관리하도록)해 단일 책임 원칙을 지켜야 한다.


## 가능한 실행경로
```
 public class IdGenerator{
  private int lastIdUsed;
  
  public int incrementValue(){
    return ++lastIdUsed;
  }
 }
```
만약 lastIdUsed 초깃값을 93으로 가정할때 가능한 결과는 다음과 같다
  - case1) A 스레드는 94을 받는다. B 스레드는 95를 받는다. lastIdUsed는 95가 된다.
  - case2) A 스레드는 95를 받는다. B 스레드는 94을 받는다. lastIdUsed는 95가 된다.
  - case3) A 스레드는 94을 받는다. B 스레드는 94을 받는다. lastIdUsed는 94이 된다.
어이없게도 마지막 결과도 가능하다.

### 경로 수
위 코드중 return ++lastIdUsed 라는 코드 한줄은 바이트 코드 명령 8개에 해당한다
만약 두 스레드가 명령 8개를 뒤섞어 실행할 경우 경우의 수는 엄청 많아지게 된다
루프나 분기가 없는 명령 T개를 스레드 N개가 차례로 실행한다면 가능한 경로수는 다음과 같다
```
 (NT)!
------
  T!ⁿ
```

